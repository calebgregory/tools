#!/usr/bin/env bash
#MISE description="Split audio into chunks at silence boundaries (~20min each)"
set -euo pipefail

in="${1:?usage: mise run audio:split:split-on-silence <audio.m4a> <workdir>}"
workdir="${2:?usage: mise run audio:split_smart <audio.m4a> <workdir>}"

log="$workdir/silence.log"
cuts_file="$workdir/cuts.txt"
chunks_dir="$workdir/chunks"
mkdir -p "$chunks_dir"

if [[ ! -f "$log" ]]; then
  echo "Missing $log. Run: mise run audio:detect_silence -- <input> <workdir>" >&2
  exit 1
fi

# 20 minutes = 1200s; pick nearest silence within +/- 90s (set window 0 to disable)
uv run transcribe/choose_silence_cuts.py "$log" "$cuts_file" --every 1200 --window 90
CUTS="$(cat "$cuts_file")"

ffmpeg -hide_banner -loglevel error \
  -i "$in" \
  -f segment -segment_times "$CUTS" -reset_timestamps 1 \
  -c copy "$chunks_dir/chunk_%03d.m4a"

echo "Chunks in: $chunks_dir"
